<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin — Invitados</title>
</head>
<body>

  <h1>Lista de invitados</h1>
  <p id="status"></p>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <button id="download">Descargar Excel</button>
  <script>
    const SUPABASE_URL = "https://eurobrvauarexooknbpi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AuBKM60iM53tjH4ptBGENQ_7MVuBcum";
    const ADMIN_TOKEN = "SONPARERA";

     // sacar token de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if(token !== ADMIN_TOKEN){
    document.body.innerHTML = "<h2>Acceso denegado</h2>";
    throw "Token inválido";
  }

  // Solo si token correcto inicializamos Supabase
  const supabaseAdmin = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  document.getElementById("download").addEventListener("click", async () => {
  const { data, error } = await supabaseAdmin
    .from("invitados")
    .select("name,email,guests,comment,created_at");

  if(error){
    alert("Error al descargar: "+error.message);
    return;
  }

  downloadExcel(data);
});

  function downloadExcel(rows) {
  // 1️⃣ Crear array de datos
  const data = rows.map(r => ({
    Nombre: r.name,
    Email: r.email,
    Invitados: r.guests,
    Comentario: r.comment,
    Fecha: r.created_at
  }));

  // 2️⃣ Crear libro y hoja
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data, { header: ["Nombre","Email","Invitados","Comentario","Fecha"] });

  // 3️⃣ Formato de header
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let C = range.s.c; C <= range.e.c; ++C) {
    const cell = ws[XLSX.utils.encode_cell({r:0, c:C})];
    if(!cell.s) cell.s = {};
    cell.s.font = { bold: true }; // header en negrita
  }

  // 4️⃣ Ajustar ancho de columnas y wrap text
  ws['!cols'] = [
    { wch: 44 }, // Nombre
    { wch: 44 }, // Email
    { wch: 44 }, // Invitados
    { wch: 44 }, // Comentario
    { wch: 44 }  // Fecha
  ];

  // Wrap text en todas las celdas
  for(let R = range.s.r; R <= range.e.r; ++R) {
    for(let C = range.s.c; C <= range.e.c; ++C) {
      const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
      if(!cell.s) cell.s = {};
      cell.s.alignment = { wrapText: true };
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "Invitados");

  // 5️⃣ Descargar archivo
  XLSX.writeFile(wb, "Lista_de_invitados.xlsx");
}

  </script>

</body>
</html>
