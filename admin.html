<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äî Invitados</title>
</head>
<body>

  <h1>Lista de invitados</h1>
  <p id="status"></p>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <button id="download">Descargar Excel</button>
  <script>
    const SUPABASE_URL = "https://eurobrvauarexooknbpi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AuBKM60iM53tjH4ptBGENQ_7MVuBcum";
    const ADMIN_TOKEN = "SONPARERA";

     // sacar token de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if(token !== ADMIN_TOKEN){
    document.body.innerHTML = "<h2>Acceso denegado</h2>";
    throw "Token inv√°lido";
  }

  // Solo si token correcto inicializamos Supabase
  const supabaseAdmin = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  document.getElementById("download").addEventListener("click", async () => {
  const { data, error } = await supabaseAdmin
    .from("rsvp")
    .select("name,email,bus,comment,created_at");

  if(error){
    alert("Error al descargar: "+error.message);
    return;
  }

  downloadExcel(data);
});

function downloadExcel(rows) {

  if (!rows || rows.length === 0) {
    alert("No hay invitados registrados todav√≠a");
    return;
  }

  // 1Ô∏è‚É£ Crear array de datos
  const data = rows.map(r => ({
    Nombre: r.name || "",
    Email: r.email || "",
    BusCoche: r.bus || "",
    Comentario: r.comment || "",
    Fecha: new Date(r.created_at).toLocaleString()
  }));

  // 2Ô∏è‚É£ Crear libro y hoja
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data, {
    header: ["Nombre","Email","BusCoche","Comentario","Fecha"],
    origin: "A1"
  });

  // üîê Seguridad: asegurarse que la hoja tiene referencia
  if (!ws["!ref"]) {
    alert("No se pudo generar el archivo Excel");
    return;
  }

  // 3Ô∏è‚É£ Formato de header en negrita y wrap text
  const range = XLSX.utils.decode_range(ws["!ref"]);

  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cell = ws[XLSX.utils.encode_cell({ r: 0, c: C })];
    if (cell) {
      if (!cell.s) cell.s = {};
      cell.s.font = { bold: true };
      cell.s.alignment = { wrapText: true };
    }
  }

  // 4Ô∏è‚É£ Formato de todas las celdas con wrap text
  for (let R = 1; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
      if (cell) {
        if (!cell.s) cell.s = {};
        cell.s.alignment = { wrapText: true };
      }
    }
  }

  // 5Ô∏è‚É£ Ajustar ancho de columnas
  ws["!cols"] = [
    { wch: 22 },
    { wch: 30 },
    { wch: 15 },
    { wch: 30 },
    { wch: 22 }
  ];

  // 6Ô∏è‚É£ Filtros autom√°ticos
  ws["!autofilter"] = { ref: ws["!ref"] };

  // 7Ô∏è‚É£ Resaltar filas si BusCoche tiene valor
  for (let R = 1; R <= range.e.r; ++R) {
    const cell = ws[XLSX.utils.encode_cell({ r: R, c: 2 })];
    if (cell && cell.v) {
      if (!cell.s) cell.s = {};
      cell.s.fill = { fgColor: { rgb: "FFFFE4E1" } };
    }
  }

  // 8Ô∏è‚É£ A√±adir hoja y descargar
  XLSX.utils.book_append_sheet(wb, ws, "Invitados");
  XLSX.writeFile(wb, "Lista_de_invitados.xlsx");
}

  </script>

</body>
</html>
