<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin — Invitados</title>
</head>
<body>

  <h1>Lista de invitados</h1>
  <p id="status"></p>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <button id="download">Descargar Excel</button>
  <script>
    const SUPABASE_URL = "https://eurobrvauarexooknbpi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AuBKM60iM53tjH4ptBGENQ_7MVuBcum";
    const ADMIN_TOKEN = "SONPARERA";

     // sacar token de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if(token !== ADMIN_TOKEN){
    document.body.innerHTML = "<h2>Acceso denegado</h2>";
    throw "Token inválido";
  }

  // Solo si token correcto inicializamos Supabase
  const supabaseAdmin = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  document.getElementById("download").addEventListener("click", async () => {
  const { data, error } = await supabaseAdmin
    .from("rsvp")
    .select("name,email,bus,comment,created_at");

  if(error){
    alert("Error al descargar: "+error.message);
    return;
  }

  downloadExcel(data);
});

  function downloadExcel(rows) {
  // 1️⃣ Crear array de datos
  const data = rows.map(r => ({
    Nombre: r.name,
    Email: r.email,
    BusCoche: r.bus,
    Comentario: r.comment,
    Fecha: r.created_at
  }));

  /// 2️⃣ Crear libro y hoja
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data, {
    header: ["Nombre","Email","BusCOche","Comentario","Fecha"],
    origin: "A1"
  });

  // 3️⃣ Formato de header en negrita y wrap text
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let C = range.s.c; C <= range.e.c; ++C) {
    const cell = ws[XLSX.utils.encode_cell({r:0, c:C})];
    if(!cell.s) cell.s = {};
    cell.s.font = { bold: true };
    cell.s.alignment = { wrapText: true };
  }

  // 4️⃣ Formato de todas las celdas con wrap text
  for(let R = 1; R <= range.e.r; ++R){
    for(let C = range.s.c; C <= range.e.c; ++C){
      const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
      if(!cell.s) cell.s = {};
      cell.s.alignment = { wrapText: true };
    }
  }

  // 5️⃣ Ajustar ancho de columnas
  ws['!cols'] = [
    { wch: 22 }, // Nombre
    { wch: 22 }, // Email
    { wch: 22 }, // Invitados
    { wch: 22 }, // Comentario
    { wch: 22 }  // Fecha
  ];

  // 6️⃣ Convertir hoja a tabla (Excel Table) para filtros automáticos
  ws['!autofilter'] = { ref: ws['!ref'] };

  // 7️⃣ Opcional: conditional formatting (resaltar filas según condición)
  // SheetJS puro no soporta full Excel conditional formatting
  // Pero puedes resaltar manualmente, por ejemplo: invitados > 0 en color
  for(let R = 1; R <= range.e.r; ++R){
    const cell = ws[XLSX.utils.encode_cell({r:R, c:2})]; // columna Invitados
    if(cell.v > 0){
      if(!cell.s) cell.s = {};
      cell.s.fill = { fgColor: { rgb: "FFFFC0CB" } }; // rosa claro
    }
  }

  // 8️⃣ Añadir hoja al libro
  XLSX.utils.book_append_sheet(wb, ws, "Invitados");

  // 9️⃣ Descargar archivo
  XLSX.writeFile(wb, "Lista_de_invitados.xlsx");
}

  </script>

</body>
</html>
